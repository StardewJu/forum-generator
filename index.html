<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è®ºå›ä½“ç”Ÿæˆå™¨ (ä¸‹æ‹‰å­˜æ¡£ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        .preview-area { background-color: #FDF9EE; }
        .post-card { border-bottom: 1px solid #E2DCC8; }
        .post-card:hover .action-buttons { opacity: 1; }
        .action-buttons { opacity: 0; transition: opacity 0.2s; }
        .quote-box { background-color: #F7F2E2; border: 1px solid #E6E1D0; color: #666; }
    </style>
</head>
<body class="bg-gray-100 h-screen p-5">

    <div id="app" class="flex gap-5 h-full">
        
        <div class="w-1/3 bg-white p-5 rounded shadow flex flex-col gap-4 overflow-auto">
            <h2 class="text-xl font-bold flex justify-between items-center">
                <span>ç¼–è¾‘æ§åˆ¶å°</span>
                <span class="text-xs font-normal text-gray-400">å·²å¯ç”¨è‡ªåŠ¨å­˜æ¡£</span>
            </h2>
            
            <div class="bg-gray-800 text-white p-3 rounded-lg shadow-md mb-2">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-sm">ğŸ’¾ å­˜æ¡£ç®¡ç†</h2>
                    <span class="text-[10px] bg-green-600 px-2 py-0.5 rounded text-white">{{ currentSaveSlot }}</span>
                </div>
                
                <select @change="selectSaveFromList" class="w-full text-black text-xs p-1.5 rounded mb-2 bg-gray-200 border-none cursor-pointer hover:bg-white transition-colors">
                    <option value="" disabled selected>ğŸ“‚ ç‚¹å‡»é€‰æ‹©å·²æœ‰å­˜æ¡£...</option>
                    <option v-for="name in saveList" :value="name">{{ name }}</option>
                </select>

                <div class="flex gap-2">
                    <input v-model.lazy="currentSaveSlot" @change="switchSaveSlot" class="w-full text-black text-xs p-1.5 rounded" placeholder="è¾“å…¥æ–°åå­—å¯æ–°å»ºå­˜æ¡£">
                    <button @click="resetCurrentSlot" class="bg-red-600 hover:bg-red-700 text-xs text-white px-3 rounded h-8 whitespace-nowrap">åˆ é™¤å½“å‰</button>
                </div>
                <p class="text-[10px] text-gray-400 mt-1">ğŸ’¡ é€‰ä¸‹æ‹‰æ¡†åˆ‡æ¢æ—§å­˜æ¡£ï¼Œæˆ–åœ¨è¾“å…¥æ¡†æ‰“å­—å»ºæ–°å­˜æ¡£ã€‚</p>
            </div>

            <div class="space-y-2 mb-2 border-b pb-4">
                <label class="block text-sm font-bold text-gray-700">é¡¶éƒ¨è®¾ç½®</label>
                <div class="flex gap-2">
                    <input v-model="forumName" class="w-1/2 border p-1 rounded text-sm" placeholder="è®ºå›å">
                    <input v-model="subForum" class="w-1/2 border p-1 rounded text-sm" placeholder="æ¿å—å">
                </div>
                <div class="bg-blue-50 p-2 rounded border border-blue-100 flex gap-2 items-start">
                    <div class="flex flex-col items-center gap-1">
                        <div class="w-10 h-10 rounded border border-blue-200 bg-white overflow-hidden relative group">
                            <img :src="lzAvatar || 'https://api.dicebear.com/7.x/lorelei/svg?seed=lz'" class="w-full h-full object-cover">
                            <label class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-[8px] opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                æ¢å›¾ <input type="file" accept="image/*" @change="handleLzAvatarUpload" class="hidden">
                            </label>
                        </div>
                        <span v-if="lzAvatar" @click="lzAvatar = null" class="text-[10px] text-red-500 cursor-pointer underline">è¿˜åŸ</span>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-blue-600 mb-1">ğŸ‘‘ æ¥¼ä¸»ç»Ÿä¸€ID</label>
                        <input v-model="globalLzName" class="w-full border p-1 rounded text-sm font-bold text-blue-800" placeholder="æ¥¼ä¸»ID">
                    </div>
                </div>
                <input v-model="threadTitle" class="w-full border p-1 rounded text-sm font-bold" placeholder="å¸–å­æ ‡é¢˜">
                <div class="flex items-center text-xs text-gray-500">
                    <span class="mr-2">ğŸ‘€ æµè§ˆé‡:</span>
                    <input v-model="viewCount" type="number" class="border p-1 rounded w-20">
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">ğŸ­ è§’è‰²åº“</label>
                <select v-model="selectedPreset" @change="applyPreset" class="w-full border p-2 rounded text-sm bg-white mb-2">
                    <option value="" disabled>-- å¿«é€Ÿé€‰æ‹©é¢„è®¾è§’è‰² --</option>
                    <option v-for="role in presets" :value="role.name">{{ role.name }} ({{ role.id }})</option>
                </select>
                <div class="p-3 bg-white border border-gray-200 rounded shadow-sm text-sm flex gap-3 items-start">
                    <div class="flex flex-col items-center gap-1">
                        <div class="w-10 h-10 rounded border border-gray-300 overflow-hidden bg-gray-100 relative group">
                            <img :src="newPresetAvatar || ('https://api.dicebear.com/7.x/lorelei/svg?seed=' + (newPresetId || 'default'))" class="w-full h-full object-cover">
                            <label class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-[8px] opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                ä¸Šä¼  <input type="file" accept="image/*" @change="handlePresetAvatarUpload" class="hidden" id="presetImgInput">
                            </label>
                        </div>
                        <button v-if="newPresetAvatar" @click="clearPresetAvatar" class="text-[10px] text-red-500 underline">æ¸…é™¤</button>
                    </div>
                    <div class="flex-1 flex flex-col gap-2">
                        <input v-model="newPresetName" placeholder="å¤‡æ³¨" class="w-full border p-1 rounded text-xs">
                        <input v-model="newPresetId" placeholder="ID" class="w-full border p-1 rounded text-xs">
                        <button @click="addCustomPreset" class="w-full bg-gray-700 text-white py-1 rounded hover:bg-gray-800 text-xs">ä¿å­˜</button>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold">å½“å‰å‘è¨€èº«ä»½</label>
                <div class="flex gap-2 mt-1 mb-2">
                    <button @click="switchToLz" :class="{'bg-blue-600 ring-2 ring-blue-300': currentRole==='LZ', 'bg-blue-400': currentRole!=='LZ'}" class="px-4 py-1 text-white rounded text-sm font-bold transition-all">æ¥¼ä¸»</button>
                    <button @click="switchToRoadman" :class="{'bg-green-600 ring-2 ring-green-300': currentRole==='è·¯äºº', 'bg-green-400': currentRole!=='è·¯äºº'}" class="px-4 py-1 text-white rounded text-sm font-bold transition-all">è·¯äºº</button>
                </div>
                <input v-model="currentId" class="w-full border p-2 rounded bg-gray-50" type="text" placeholder="ç”¨æˆ·ID">
            </div>

            <div>
                <div class="mb-2">
                    <label class="block text-sm font-bold mb-1">ğŸ•’ è‡ªå®šä¹‰æ—¶é—´</label>
                    <input v-model="customTime" class="w-full border p-1 rounded text-sm bg-yellow-50 focus:bg-white transition-colors" placeholder="ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆå½“å‰æ—¶é—´">
                </div>

                <div class="flex justify-between items-center mb-1 flex-wrap gap-2">
                    <label class="block text-sm font-bold">å›å¤å†…å®¹</label>
                    <div class="flex gap-2 flex-wrap">
                        <span v-if="insertIndex !== -1" class="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded animate-pulse">
                            âœ¨ æ’æ¥¼ ({{ insertIndex }}L) <button @click="cancelInsert" class="ml-1 text-red-500 underline">Ã—</button>
                        </span>
                        <span v-if="editingIndex !== -1" class="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded animate-pulse">
                            âœ ä¿®æ”¹ ({{ editingIndex }}L) <button @click="cancelEdit" class="ml-1 text-red-500 underline">Ã—</button>
                        </span>
                        <span v-if="replyTarget" class="text-xs font-bold text-cyan-600 bg-cyan-100 px-2 py-1 rounded">
                            â†©ï¸ å›å¤ {{ replyTarget.floor }}L <button @click="cancelReply" class="ml-1 text-red-500 underline">Ã—</button>
                        </span>
                    </div>
                </div>
                <textarea v-model="content" class="w-full border p-2 rounded h-24" placeholder="è¾“å…¥å†…å®¹..."></textarea>
                
                <div class="mt-2 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <label class="text-xs font-bold bg-gray-200 px-2 py-1 rounded cursor-pointer hover:bg-gray-300">
                            ğŸ“· ä¸Šä¼ å›¾ç‰‡ <input id="imgInput" type="file" accept="image/*" @change="handleImageUpload" class="hidden" />
                        </label>
                        <span v-if="currentImage" class="text-xs text-green-600">å·²é€‰å›¾ âœ…</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="text-xs font-bold text-gray-500">ğŸ‘ç‚¹èµ:</span>
                        <input v-model="currentLikeCount" type="number" class="w-16 border p-1 rounded text-xs text-center" placeholder="0">
                    </div>
                </div>
                <div v-if="currentImage" class="mt-2">
                    <img :src="currentImage" class="h-16 rounded border border-gray-300">
                </div>
            </div>

            <div class="bg-gray-50 p-3 rounded border flex items-center gap-6">
                 <label class="flex items-center cursor-pointer select-none">
                     <input type="checkbox" v-model="showAvatar" class="w-4 h-4 text-blue-600 cursor-pointer"> <span class="ml-2 text-sm text-gray-700">æ˜¾ç¤ºå¤´åƒ</span>
                 </label>
                 <label class="flex items-center cursor-pointer select-none">
                     <input type="checkbox" v-model="showTime" class="w-4 h-4 text-blue-600 cursor-pointer"> <span class="ml-2 text-sm text-gray-700">æ˜¾ç¤ºæ—¶é—´</span>
                 </label>
            </div>
            
            <button @click="addPost" 
                :class="editingIndex !== -1 ? 'bg-orange-500 hover:bg-orange-600' : (insertIndex !== -1 ? 'bg-purple-600 hover:bg-purple-700' : 'bg-blue-600 hover:bg-blue-700')"
                class="text-white py-3 rounded shadow font-bold text-lg transition-colors w-full">
                {{ editingIndex !== -1 ? 'ğŸ’¾ ä¿å­˜ä¿®æ”¹' : (insertIndex !== -1 ? 'âœ¨ ç¡®è®¤æ’å…¥æ¥¼å±‚' : (replyTarget ? 'â†©ï¸ å‘é€å›å¤' : 'å‘é€ (è¿½åŠ æ¥¼å±‚)')) }}
            </button>
            
            <hr>
            
            <button @click="exportImage" class="bg-red-600 text-white py-2 rounded hover:bg-red-700 shadow w-full font-bold">
                ğŸ“¸ ç”Ÿæˆé•¿æˆªå›¾
            </button>
        </div>

        <div class="w-2/3 overflow-auto bg-gray-200 p-5">
            <div id="capture-area" class="preview-area min-h-[800px] w-full max-w-[600px] mx-auto shadow-2xl text-sm text-gray-800 font-sans relative pb-10">
                
                <div class="bg-[#4C281B] p-2 text-xs font-sans border-b border-gray-200 text-white">
                     <span>{{ forumName }}</span> &gt; <span>{{ subForum }}</span>
                </div>

                <div class="bg-white m-4 p-4 rounded-lg shadow-sm border border-gray-200">
                    <h1 class="text-xl font-bold text-gray-800 mb-3 tracking-wide leading-snug">{{ threadTitle }}</h1>
                    <div class="flex items-center text-xs text-gray-500 gap-4">
                        <div class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <span>{{ viewCount }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span>{{ posts.length > 0 ? posts.length - 1 : 0 }}</span>
                        </div>
                    </div>
                </div>

                <div v-for="(post, index) in posts" :key="index" class="post-card p-4 flex gap-3 relative group">
                    <div v-if="showAvatar" class="w-12 flex-shrink-0 text-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-md mx-auto mb-1 overflow-hidden border border-gray-300">
                          <img :src="getAvatarForId(post.id, post.role)" class="w-full h-full object-cover" />
                        </div>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between text-xs text-gray-500 mb-1 items-center">
                            <span class="font-bold text-[#562214] flex items-center gap-1">
                                {{ post.id }}
                                <span v-if="post.role === 'LZ'" class="bg-blue-100 text-blue-700 text-[10px] px-1 rounded border border-blue-200 leading-tight">æ¥¼ä¸»</span>
                            </span>
                            <span>
                                <span v-if="showTime">{{ post.time }} | </span>
                                {{ index }}L
                            </span>
                        </div>
                        
                        <div v-if="post.quote" class="quote-box p-2 mb-2 rounded text-xs">
                            <div class="font-bold mb-1 border-b border-gray-300 pb-1 flex justify-between">
                                <span>å¼•ç”¨ {{ post.quote.floor }}L ({{ post.quote.id }}) çš„å‘è¨€:</span>
                            </div>
                            <div class="leading-relaxed opacity-80 whitespace-pre-wrap line-clamp-3">{{ post.quote.content }}</div>
                        </div>

                        <div v-if="post.content" class="leading-relaxed whitespace-pre-wrap break-words">{{ post.content }}</div>

                        <div v-if="post.image" class="mt-3">
                            <img :src="post.image" class="max-w-full max-h-[500px] rounded border border-gray-200 mx-auto shadow-sm block" />
                        </div>

                        <div class="mt-2 flex justify-end items-center gap-1 text-xs text-gray-500">
                            <svg class="w-3 h-3 text-gray-400" fill="currentColor" viewBox="0 0 24 24"><path d="M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z"></path></svg>
                            <span>{{ post.likeCount || 0 }}</span>
                        </div>
                    </div>

                    <div class="action-buttons absolute right-2 top-2 flex gap-1" data-html2canvas-ignore="true">
                        <button @click="prepareReply(index)" title="å›å¤/å¼•ç”¨" class="bg-cyan-100 text-cyan-600 hover:bg-cyan-200 p-1 rounded text-xs w-6 h-6 flex items-center justify-center font-bold">â†©ï¸</button>
                        <button @click="editPost(index)" title="ç¼–è¾‘" class="bg-orange-100 text-orange-600 hover:bg-orange-200 p-1 rounded text-xs w-6 h-6 flex items-center justify-center font-bold">âœ</button>
                        <button @click="prepareInsert(index)" title="æ’æ¥¼" class="bg-purple-100 text-purple-600 hover:bg-purple-200 p-1 rounded text-xs w-6 h-6 flex items-center justify-center font-bold">+</button>
                        <button @click="deletePost(index)" title="åˆ é™¤" class="bg-red-100 text-red-600 hover:bg-red-200 p-1 rounded text-xs w-6 h-6 flex items-center justify-center font-bold">Ã—</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, watch, onMounted } = Vue;

        createApp({
            setup() {
                const currentSaveSlot = ref("é»˜è®¤å­˜æ¡£");
                const saveList = ref([]); // ã€æ–°å¢ã€‘å­˜æ¡£åˆ—è¡¨
                
                const threadTitle = ref("æ±‚åŠ©ï¼æˆ‘çš„å®¤å‹å¥½åƒæ˜¯ä¸ªæ€æ‰‹...");
                const forumName = ref("é¹ˆé¹•é•‡ç¤¾åŒº");
                const subForum = ref("æ·±å¤œå†œåœº");
                const globalLzName = ref(""); 
                const lzAvatar = ref(null); 
                const viewCount = ref(5832);
                
                const currentRole = ref("LZ");
                const currentId = ref("æ— åŠ©çš„æ¥¼ä¸»");
                const content = ref("");
                const currentImage = ref(null);
                const showAvatar = ref(true);
                const showTime = ref(true); 
                const insertIndex = ref(-1);
                const editingIndex = ref(-1);
                const currentLikeCount = ref(0);
                const replyTarget = ref(null);
                const customTime = ref(""); 

                const posts = ref([]);

                const presets = ref([
                    { name: 'è·¯äººç”²', role: 'è·¯äºº', id: 'è·¯äººç”²' },
                    { name: 'å¡å·´æ–¯è’‚å®‰', role: 'è·¯äºº', id: 'å¡å·´æ–¯è’‚å®‰' },
                    { name: 'ä¾¦æ¢', role: 'è·¯äºº', id: 'åˆ—æ–‡è™å…‹' }
                ]);
                const selectedPreset = ref("");          
                const newPresetName = ref(""); 
                const newPresetId = ref("");   
                const newPresetAvatar = ref(null);

                const fileToBase64 = (file) => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(file);
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = error => reject(error);
                    });
                };

                const switchToLz = () => { currentRole.value = 'LZ'; currentId.value = globalLzName.value; };
                const switchToRoadman = () => { currentRole.value = 'è·¯äºº'; currentId.value = "è·¯äºº" + String.fromCharCode(65 + Math.floor(Math.random() * 26)); };

                const applyPreset = () => {
                    const target = presets.value.find(p => p.name === selectedPreset.value);
                    if (target) {
                        currentRole.value = target.role;
                        if (target.role === 'LZ') currentId.value = globalLzName.value;
                        else currentId.value = target.id;
                    }
                };

                const handlePresetAvatarUpload = async (e) => { if (e.target.files[0]) newPresetAvatar.value = await fileToBase64(e.target.files[0]); };
                const handleLzAvatarUpload = async (e) => { if (e.target.files[0]) lzAvatar.value = await fileToBase64(e.target.files[0]); };
                const handleImageUpload = async (e) => { if (e.target.files[0]) currentImage.value = await fileToBase64(e.target.files[0]); };

                const clearPresetAvatar = () => {
                    newPresetAvatar.value = null;
                    const fileInput = document.getElementById('presetImgInput');
                    if (fileInput) fileInput.value = '';
                };

                const addCustomPreset = () => {
                    if (!newPresetName.value || !newPresetId.value) { alert("è¯·å¡«å†™è§’è‰²å¤‡æ³¨å’ŒIDï¼"); return; }
                    presets.value.push({ name: newPresetName.value, role: 'è·¯äºº', id: newPresetId.value, avatarUrl: newPresetAvatar.value });
                    newPresetName.value = ""; newPresetId.value = ""; newPresetAvatar.value = null;
                    document.getElementById('presetImgInput').value = ''; 
                };

                const addPost = () => {
                    if (!content.value && !currentImage.value) return;

                    let finalTime;
                    if (customTime.value && customTime.value.trim() !== "") {
                        finalTime = customTime.value;
                    } else {
                        finalTime = editingIndex.value !== -1 
                            ? posts.value[editingIndex.value].time 
                            : new Date().toLocaleTimeString('en-US', { hour12: false, hour: "2-digit", minute: "2-digit" });
                    }

                    const newPostData = {
                        role: currentRole.value,
                        id: currentId.value || (currentRole.value === 'LZ' ? globalLzName.value : 'è·¯äººX'),
                        content: content.value,
                        image: currentImage.value,
                        likeCount: currentLikeCount.value,
                        quote: replyTarget.value, 
                        time: finalTime
                    };

                    if (editingIndex.value !== -1) {
                        posts.value[editingIndex.value] = newPostData;
                        editingIndex.value = -1;
                    } else if (insertIndex.value !== -1) {
                        posts.value.splice(insertIndex.value + 1, 0, newPostData);
                        insertIndex.value = -1;
                    } else {
                        posts.value.push(newPostData);
                    }
                    
                    content.value = "";
                    currentImage.value = null;
                    currentLikeCount.value = 0;
                    replyTarget.value = null;
                    customTime.value = ""; 
                    document.getElementById('imgInput').value = ''; 
                };

                const deletePost = (index) => { if(confirm("åˆ æ‰è¿™å±‚æ¥¼ï¼Ÿ")) posts.value.splice(index, 1); };
                const prepareInsert = (index) => { insertIndex.value = index; editingIndex.value = -1; replyTarget.value = null; customTime.value = ""; };
                const cancelInsert = () => { insertIndex.value = -1; };
                
                const prepareReply = (index) => {
                    const p = posts.value[index];
                    replyTarget.value = {
                        id: p.id,
                        floor: index,
                        content: p.content || (p.image ? '[å›¾ç‰‡]' : '...')
                    };
                    insertIndex.value = -1; editingIndex.value = -1;
                    document.querySelector('textarea').focus();
                };
                const cancelReply = () => { replyTarget.value = null; };

                const editPost = (index) => {
                    const post = posts.value[index];
                    content.value = post.content || "";
                    currentRole.value = post.role;
                    currentId.value = post.id;
                    currentImage.value = post.image || null;
                    currentLikeCount.value = post.likeCount || 0;
                    replyTarget.value = post.quote || null;
                    customTime.value = post.time || ""; 
                    editingIndex.value = index;
                    insertIndex.value = -1;
                };
                const cancelEdit = () => {
                    editingIndex.value = -1;
                    content.value = "";
                    currentImage.value = null;
                    currentLikeCount.value = 0;
                    replyTarget.value = null;
                    customTime.value = ""; 
                    document.getElementById('imgInput').value = '';
                };

                const resetCurrentSlot = () => {
                    if(confirm(`ç¡®å®šæ¸…ç©ºã€${currentSaveSlot.value}ã€‘çš„æ‰€æœ‰å†…å®¹å—ï¼Ÿ`)) {
                        localStorage.removeItem(getStorageKey());
                        loadData(); 
                    }
                    updateSaveList(); // åˆ·æ–°åˆ—è¡¨
                };

                const exportImage = () => {
                    html2canvas(document.getElementById("capture-area"), {
                        useCORS: true,
                        ignoreElements: (el) => el.getAttribute('data-html2canvas-ignore') === 'true'
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Forum_Gen_${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                };

                const getAvatarForId = (id, role) => {
                    if (role === 'LZ') {
                        if (lzAvatar.value) return lzAvatar.value;
                        return "https://api.dicebear.com/7.x/lorelei/svg?seed=lz";
                    }
                    const preset = presets.value.find(p => p.id === id && p.avatarUrl);
                    if (preset) return preset.avatarUrl; 
                    return `https://api.dicebear.com/7.x/lorelei/svg?seed=${encodeURIComponent(id)}`;
                };

                // --- å­˜æ¡£ä¸ä¸‹æ‹‰åˆ—è¡¨é€»è¾‘ ---
                const getStorageKey = () => `forum_data_${currentSaveSlot.value.trim() || 'default'}`;

                // ã€æ–°å¢ã€‘æ›´æ–°å­˜æ¡£åˆ—è¡¨
                const updateSaveList = () => {
                    const list = [];
                    for(let i=0; i<localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if(key.startsWith('forum_data_')) {
                            list.push(key.replace('forum_data_', ''));
                        }
                    }
                    saveList.value = list;
                };

                const loadData = () => {
                    const saved = localStorage.getItem(getStorageKey());
                    if(saved) {
                        try {
                            const p = JSON.parse(saved);
                            posts.value = p.posts || [];
                            presets.value = p.presets || [];
                            threadTitle.value = p.threadTitle || "æ–°å¸–å­";
                            forumName.value = p.forumName || "è®ºå›";
                            subForum.value = p.subForum || "æ¿å—";
                            globalLzName.value = p.globalLzName || "";
                            viewCount.value = p.viewCount || 5832;
                            lzAvatar.value = p.lzAvatar || null;
                            showAvatar.value = p.showAvatar !== undefined ? p.showAvatar : true;
                            showTime.value = p.showTime !== undefined ? p.showTime : true;
                        } catch(e) { console.error("è¯»å–å¤±è´¥", e); }
                    } else {
                        posts.value = [];
                        threadTitle.value = "æ–°å¸–å­æ ‡é¢˜";
                    }
                };

                // ä¸‹æ‹‰æ¡†é€‰æ‹©äº‹ä»¶
                const selectSaveFromList = (e) => {
                    currentSaveSlot.value = e.target.value;
                    loadData();
                };

                const switchSaveSlot = () => { loadData(); };

                watch(
                    [posts, presets, threadTitle, forumName, subForum, globalLzName, viewCount, lzAvatar, showAvatar, showTime],
                    () => {
                        const data = {
                            posts: posts.value, presets: presets.value, threadTitle: threadTitle.value,
                            forumName: forumName.value, subForum: subForum.value, globalLzName: globalLzName.value,
                            viewCount: viewCount.value, lzAvatar: lzAvatar.value, showAvatar: showAvatar.value, showTime: showTime.value
                        };
                        try { 
                            localStorage.setItem(getStorageKey(), JSON.stringify(data)); 
                            updateSaveList(); // ä¿å­˜æ—¶é¡ºä¾¿åˆ·æ–°åˆ—è¡¨
                        } catch(e) {}
                    }, { deep: true }
                );

                onMounted(() => { 
                    updateSaveList(); // å¯åŠ¨æ—¶åˆ·æ–°åˆ—è¡¨
                    loadData(); 
                });

                return {
                    currentSaveSlot, switchSaveSlot, resetCurrentSlot, saveList, selectSaveFromList,
                    threadTitle, forumName, subForum, globalLzName, viewCount, lzAvatar,
                    currentRole, currentId, content, posts, showAvatar, showTime, currentImage, currentLikeCount, replyTarget,
                    customTime, 
                    presets, selectedPreset, newPresetName, newPresetId, insertIndex, editingIndex,
                    switchToLz, switchToRoadman, applyPreset, addCustomPreset,
                    handleImageUpload, addPost, deletePost, prepareInsert, cancelInsert, exportImage,
                    newPresetAvatar, handlePresetAvatarUpload, getAvatarForId, clearPresetAvatar, handleLzAvatarUpload,
                    editPost, cancelEdit, prepareReply, cancelReply
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è®ºå›ä½“ç”Ÿæˆå™¨ (æœ€ç»ˆå®Œæ•´ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        .preview-area { background-color: #FDF9EE; }
        .post-card { border-bottom: 1px solid #E2DCC8; }
        .post-card:hover .action-buttons { opacity: 1; }
        .action-buttons { opacity: 0; transition: opacity 0.2s; }
    </style>
</head>
<body class="bg-gray-100 h-screen p-5">

    <div id="app" class="flex gap-5 h-full">
        
        <div class="w-1/3 bg-white p-5 rounded shadow flex flex-col gap-4 overflow-auto">
            <h2 class="text-xl font-bold">ç¼–è¾‘æ§åˆ¶å°</h2>
            
            <div class="space-y-2 mb-2 border-b pb-4">
                <label class="block text-sm font-bold text-gray-700">é¡¶éƒ¨è®¾ç½®</label>
                
                <div class="flex gap-2">
                    <input v-model="forumName" class="w-1/2 border p-1 rounded text-sm" placeholder="è®ºå›å (å¦‚: NGA)">
                    <input v-model="subForum" class="w-1/2 border p-1 rounded text-sm" placeholder="æ¿å—å (å¦‚: æ™´é£æ‘)">
                </div>

                <div class="bg-blue-50 p-2 rounded border border-blue-100 flex gap-2 items-start">
                    <div class="flex flex-col items-center gap-1">
                        <div class="w-10 h-10 rounded border border-blue-200 bg-white overflow-hidden relative group">
                            <img :src="lzAvatar || 'https://api.dicebear.com/7.x/pixel-art/svg?seed=lz'" class="w-full h-full object-cover">
                            <label class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-[8px] opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                æ¢å›¾
                                <input type="file" accept="image/*" @change="handleLzAvatarUpload" class="hidden">
                            </label>
                        </div>
                        <span v-if="lzAvatar" @click="lzAvatar = null" class="text-[10px] text-red-500 cursor-pointer underline">è¿˜åŸ</span>
                    </div>
                
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-blue-600 mb-1">ğŸ‘‘ æ¥¼ä¸»ç»Ÿä¸€ID</label>
                        <input v-model="globalLzName" class="w-full border p-1 rounded text-sm font-bold text-blue-800" placeholder="ä¾‹å¦‚: é’®ç¥œç¦„Â·ç”„å¬›">
                    </div>
                </div>
                
                <input v-model="threadTitle" class="w-full border p-1 rounded text-sm font-bold" placeholder="å¸–å­æ ‡é¢˜">
                
                <div class="flex items-center text-xs text-gray-500">
                    <span class="mr-2">ğŸ‘€ æµè§ˆé‡:</span>
                    <input v-model="viewCount" type="number" class="border p-1 rounded w-20">
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">ğŸ­ è§’è‰²åº“</label>
                <select v-model="selectedPreset" @change="applyPreset" class="w-full border p-2 rounded text-sm bg-white mb-2">
                    <option value="" disabled>-- å¿«é€Ÿé€‰æ‹©é¢„è®¾è§’è‰² --</option>
                    <option v-for="role in presets" :value="role.name">
                        {{ role.name }} ({{ role.id }})
                    </option>
                </select>

                <div class="p-3 bg-white border border-gray-200 rounded shadow-sm text-sm">
                    <div class="font-bold text-gray-500 mb-2 text-xs flex justify-between items-center">
                        <span>â• æ·»åŠ æ–°é©¬ç”²</span>
                        <span class="text-[10px] font-normal text-gray-400">ä¸ä¼ å¤´åƒåˆ™è‡ªåŠ¨ç”Ÿæˆ</span>
                    </div>

                    <div class="flex gap-3 items-start">
                        <div class="flex flex-col items-center gap-1">
                            <div class="w-10 h-10 rounded border border-gray-300 overflow-hidden bg-gray-100 relative group">
                                <img 
                                    :src="newPresetAvatar || ('https://api.dicebear.com/7.x/pixel-art/svg?seed=' + (newPresetId || 'default'))" 
                                    class="w-full h-full object-cover"
                                >
                                <label class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-[8px] opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity">
                                    ä¸Šä¼ 
                                    <input type="file" accept="image/*" @change="handlePresetAvatarUpload" class="hidden" id="presetImgInput">
                                </label>
                            </div>
                            <button v-if="newPresetAvatar" @click="clearPresetAvatar" class="text-[10px] text-red-500 underline">æ¸…é™¤</button>
                        </div>

                        <div class="flex-1 flex flex-col gap-2">
                            <input v-model="newPresetName" placeholder="å¤‡æ³¨ (å¦‚: é—ºèœœ)" class="w-full border p-1 rounded text-xs">
                            <input v-model="newPresetId" placeholder="ID (å¦‚: åæ§½æ˜Ÿäºº)" class="w-full border p-1 rounded text-xs">
                            <button @click="addCustomPreset" class="w-full bg-gray-700 text-white py-1 rounded hover:bg-gray-800 text-xs">
                                ä¿å­˜åˆ°åˆ—è¡¨
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold">å½“å‰å‘è¨€èº«ä»½</label>
                <div class="flex gap-2 mt-1 mb-2">
                    <button @click="switchToLz" :class="{'bg-blue-600 ring-2 ring-blue-300': currentRole==='LZ', 'bg-blue-400': currentRole!=='LZ'}" class="px-4 py-1 text-white rounded text-sm font-bold transition-all">
                        æ¥¼ä¸» (LZ)
                    </button>
                    <button @click="switchToRoadman" :class="{'bg-green-600 ring-2 ring-green-300': currentRole==='è·¯äºº', 'bg-green-400': currentRole!=='è·¯äºº'}" class="px-4 py-1 text-white rounded text-sm font-bold transition-all">
                        è·¯äºº (P)
                    </button>
                </div>
                <input v-model="currentId" class="w-full border p-2 rounded bg-gray-50" type="text" placeholder="ç”¨æˆ·ID">
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-sm font-bold">å›å¤å†…å®¹</label>
                    <span v-if="insertIndex !== -1" class="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded">
                        âœ¨ æ­£åœ¨ {{ insertIndex }}L åæ’å…¥
                        <button @click="cancelInsert" class="ml-1 text-red-500 underline">å–æ¶ˆ</button>
                    </span>
                </div>
                <textarea v-model="content" class="w-full border p-2 rounded h-24" placeholder="è¾“å…¥å†…å®¹..."></textarea>
                
                <div class="mt-2 flex items-center gap-2">
                    <label class="text-xs font-bold bg-gray-200 px-2 py-1 rounded cursor-pointer hover:bg-gray-300">
                        ğŸ“· ä¸Šä¼ å›¾ç‰‡
                        <input id="imgInput" type="file" accept="image/*" @change="handleImageUpload" class="hidden" />
                    </label>
                    <span v-if="currentImage" class="text-xs text-green-600">å·²é€‰å›¾ âœ…</span>
                </div>
                <div v-if="currentImage" class="mt-2">
                    <img :src="currentImage" class="h-16 rounded border border-gray-300">
                </div>
            </div>

            <div class="bg-gray-50 p-3 rounded border flex items-center gap-6">
                 <label class="flex items-center cursor-pointer select-none">
                     <input type="checkbox" v-model="showAvatar" class="w-4 h-4 text-blue-600 cursor-pointer">
                     <span class="ml-2 text-sm text-gray-700">æ˜¾ç¤ºå¤´åƒ</span>
                 </label>
                 
                 <label class="flex items-center cursor-pointer select-none">
                     <input type="checkbox" v-model="showTime" class="w-4 h-4 text-blue-600 cursor-pointer">
                     <span class="ml-2 text-sm text-gray-700">æ˜¾ç¤ºæ—¶é—´</span>
                 </label>
            </div>
            
            <button @click="addPost" 
                :class="insertIndex !== -1 ? 'bg-purple-600 hover:bg-purple-700' : 'bg-blue-600 hover:bg-blue-700'"
                class="text-white py-3 rounded shadow font-bold text-lg transition-colors w-full">
                {{ insertIndex !== -1 ? 'âœ¨ ç¡®è®¤æ’å…¥æ¥¼å±‚' : 'å‘é€ (è¿½åŠ æ¥¼å±‚)' }}
            </button>
            
            <hr>
            
            <button @click="exportImage" class="bg-red-600 text-white py-2 rounded hover:bg-red-700 shadow w-full font-bold">
                ğŸ“¸ ç”Ÿæˆé•¿æˆªå›¾
            </button>
        </div>

        <div class="w-2/3 overflow-auto bg-gray-200 p-5">
            <div id="capture-area" class="preview-area min-h-[800px] w-full max-w-[600px] mx-auto shadow-2xl text-sm text-gray-800 font-sans relative pb-10">
                
                <div class="bg-[#4C281B] p-2 text-xs font-sans border-b border-gray-200 text-white">
                     <span>{{ forumName }}</span> &gt; <span>{{ subForum }}</span>
                </div>

                <div class="bg-white m-4 p-4 rounded-lg shadow-sm border border-gray-200">
                    <h1 class="text-xl font-bold text-gray-800 mb-3 tracking-wide leading-snug">
                        {{ threadTitle }}
                    </h1>
                    <div class="flex items-center text-xs text-gray-500 gap-4">
                        <div class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                            <span>{{ viewCount }}</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span>{{ posts.length > 0 ? posts.length - 1 : 0 }}</span>
                        </div>
                    </div>
                </div>

                <div v-for="(post, index) in posts" :key="index" class="post-card p-4 flex gap-3 relative group">
                    
                    <div v-if="showAvatar" class="w-12 flex-shrink-0 text-center">
                        <div class="w-10 h-10 bg-gray-200 rounded-sm mx-auto mb-1 overflow-hidden border-2 border-gray-300">
                          <img :src="getAvatarForId(post.id, post.role)" class="w-full h-full object-cover" />
                        </div>
                    </div>
                    
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between text-xs text-gray-500 mb-1 items-center">
                            <span class="font-bold text-[#562214] flex items-center gap-1">
                                {{ post.id }}
                                <span v-if="post.role === 'LZ'" class="bg-blue-100 text-blue-700 text-[10px] px-1 rounded border border-blue-200 leading-tight">æ¥¼ä¸»</span>
                            </span>
                            <span>
                                <span v-if="showTime">{{ post.time }} | </span>
                                {{ index }}L
                            </span>
                        </div>
                        
                        <div v-if="post.content" class="leading-relaxed whitespace-pre-wrap break-words">{{ post.content }}</div>

                        <div v-if="post.image" class="mt-3">
                            <img :src="post.image" class="max-w-full max-h-[500px] rounded border border-gray-200 mx-auto shadow-sm block" />
                        </div>
                    </div>

                    <div class="action-buttons absolute right-2 top-2 flex gap-1" data-html2canvas-ignore="true">
                        <button @click="prepareInsert(index)" title="æ’æ¥¼" class="bg-purple-100 text-purple-600 hover:bg-purple-200 p-1 rounded text-xs w-6 h-6 flex items-center justify-center font-bold">+</button>
                        <button @click="deletePost(index)" title="åˆ é™¤" class="bg-red-100 text-red-600 hover:bg-red-200 p-1 rounded text-xs w-6 h-6 flex items-center justify-center font-bold">Ã—</button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                // --- 1. æ ¸å¿ƒå˜é‡å®šä¹‰ ---
                const threadTitle = ref("æ±‚åŠ©ï¼æˆ‘çš„å®¤å‹å¥½åƒæ˜¯ä¸ªæ€æ‰‹...");
                const forumName = ref("é¹ˆé¹•é•‡ç¤¾åŒº");
                const subForum = ref("æ·±å¤œå†œåœº");
                const globalLzName = ref("æ— åŠ©çš„æ¥¼ä¸»"); 
                const lzAvatar = ref(null); 
                const viewCount = ref(5832);
                
                const currentRole = ref("LZ");
                const currentId = ref("æ— åŠ©çš„æ¥¼ä¸»");
                const content = ref("");
                const currentImage = ref(null);
                const showAvatar = ref(true);
                const showTime = ref(true); // ã€æ–°å¢ã€‘æ—¶é—´å¼€å…³
                const insertIndex = ref(-1);

                // åˆå§‹æ¥¼å±‚ (ç©º)
                const posts = ref([]);

                // é¢„è®¾è§’è‰²åº“
                const presets = ref([
                    { name: 'è·¯äººç”²', role: 'è·¯äºº', id: 'è·¯äººç”²' },
                    { name: 'å¡å·´æ–¯è’‚å®‰', role: 'è·¯äºº', id: 'å¡å·´æ–¯è’‚å®‰' },
                    { name: 'ä¾¦æ¢', role: 'è·¯äºº', id: 'åˆ—æ–‡è™å…‹' }
                ]);
                const selectedPreset = ref("");          
                const newPresetName = ref(""); 
                const newPresetId = ref("");   
                const newPresetAvatar = ref(null);

                // --- 2. æ ¸å¿ƒé€»è¾‘å‡½æ•° ---

                // åˆ‡æ¢åˆ°æ¥¼ä¸»æ¨¡å¼ (è‡ªåŠ¨å¡«å…¥å…¨å±€è®¾å®šID)
                const switchToLz = () => {
                    currentRole.value = 'LZ';
                    currentId.value = globalLzName.value; 
                };

                // åˆ‡æ¢åˆ°è·¯äººæ¨¡å¼ (éšæœºID)
                const switchToRoadman = () => {
                    currentRole.value = 'è·¯äºº';
                    currentId.value = "è·¯äºº" + String.fromCharCode(65 + Math.floor(Math.random() * 26));
                };

                // åº”ç”¨é¢„è®¾
                const applyPreset = () => {
                    const target = presets.value.find(p => p.name === selectedPreset.value);
                    if (target) {
                        currentRole.value = target.role;
                        if (target.role === 'LZ') {
                            currentId.value = globalLzName.value;
                        } else {
                            currentId.value = target.id;
                        }
                    }
                };

                // è‡ªå®šä¹‰è§’è‰²å¤´åƒä¸Šä¼ é¢„è§ˆ
                const handlePresetAvatarUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        newPresetAvatar.value = URL.createObjectURL(file);
                    }
                };

                // æ¸…é™¤é¢„è§ˆå¤´åƒ
                const clearPresetAvatar = () => {
                    newPresetAvatar.value = null;
                    const fileInput = document.getElementById('presetImgInput');
                    if (fileInput) fileInput.value = '';
                };

                // æ¥¼ä¸»å¤´åƒä¸Šä¼ 
                const handleLzAvatarUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        lzAvatar.value = URL.createObjectURL(file);
                    }
                };

                // æ·»åŠ è‡ªå®šä¹‰è§’è‰²
                const addCustomPreset = () => {
                    if (!newPresetName.value || !newPresetId.value) {
                        alert("è¯·å¡«å†™è§’è‰²å¤‡æ³¨å’ŒIDï¼"); return;
                    }
                    presets.value.push({
                        name: newPresetName.value,
                        role: 'è·¯äºº',
                        id: newPresetId.value,
                        avatarUrl: newPresetAvatar.value 
                    });
                    
                    // æ¸…ç©º
                    newPresetName.value = ""; 
                    newPresetId.value = "";
                    newPresetAvatar.value = null;
                    document.getElementById('presetImgInput').value = ''; 
                };

                // å¸–å­å†…å®¹å›¾ç‰‡ä¸Šä¼ 
                const handleImageUpload = (event) => {
                    const file = event.target.files[0];
                    if (file) currentImage.value = URL.createObjectURL(file);
                };

                // å‘é€/æ’å…¥æ¥¼å±‚
                const addPost = () => {
                    if (!content.value && !currentImage.value) return;

                    const newPost = {
                        role: currentRole.value,
                        id: currentId.value || (currentRole.value === 'LZ' ? globalLzName.value : 'è·¯äººX'),
                        content: content.value,
                        image: currentImage.value,
                        time: new Date().toLocaleTimeString('en-US', { hour12: false, hour: "2-digit", minute: "2-digit" })
                    };

                    if (insertIndex.value === -1) {
                        posts.value.push(newPost);
                    } else {
                        posts.value.splice(insertIndex.value + 1, 0, newPost);
                        insertIndex.value = -1;
                    }
                    
                    content.value = "";
                    currentImage.value = null;
                    document.getElementById('imgInput').value = ''; 
                };

                // åˆ é™¤å’Œæ’å…¥å‡†å¤‡
                const deletePost = (index) => { if(confirm("åˆ æ‰è¿™å±‚æ¥¼ï¼Ÿ")) posts.value.splice(index, 1); };
                const prepareInsert = (index) => { insertIndex.value = index; };
                const cancelInsert = () => { insertIndex.value = -1; };

                // å¯¼å‡ºå›¾ç‰‡
                const exportImage = () => {
                    html2canvas(document.getElementById("capture-area"), {
                        useCORS: true,
                        ignoreElements: (el) => el.getAttribute('data-html2canvas-ignore') === 'true'
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Forum_Gen_${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                };

                // æ ¹æ®IDè·å–å¤´åƒURL
                const getAvatarForId = (id, role) => {
                    if (role === 'LZ') {
                        if (lzAvatar.value) return lzAvatar.value;
                        return "https://api.dicebear.com/7.x/pixel-art/svg?seed=lz";
                    }
                    const preset = presets.value.find(p => p.id === id && p.avatarUrl);
                    if (preset) return preset.avatarUrl; 
                    return `https://api.dicebear.com/7.x/pixel-art/svg?seed=${encodeURIComponent(id)}`;
                };

                // --- 3. æš´éœ²ç»™æ¨¡æ¿ ---
                return {
                    threadTitle, forumName, subForum, globalLzName, viewCount, lzAvatar,
                    currentRole, currentId, content, posts, showAvatar, showTime, currentImage,
                    presets, selectedPreset, newPresetName, newPresetId, insertIndex,
                    switchToLz, switchToRoadman, applyPreset, addCustomPreset,
                    handleImageUpload, addPost, deletePost, prepareInsert, cancelInsert, exportImage,
                    newPresetAvatar, handlePresetAvatarUpload, getAvatarForId, clearPresetAvatar, handleLzAvatarUpload
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
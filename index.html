<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>è®ºå›ä½“ç”Ÿæˆå™¨ (åŠ å¼ºç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        .preview-area { background-color: #FDF9EE; }
        .post-card { border-bottom: 1px solid #E2DCC8; }
        /* é¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ“ä½œæŒ‰é’® */
        .post-card:hover .action-buttons { opacity: 1; }
        .action-buttons { opacity: 0; transition: opacity 0.2s; }
    </style>
</head>
<body class="bg-gray-100 h-screen p-5">

    <div id="app" class="flex gap-5 h-full">
        
        <div class="w-1/3 bg-white p-5 rounded shadow flex flex-col gap-4 overflow-auto">
            <h2 class="text-xl font-bold">ç¼–è¾‘æ§åˆ¶å°</h2>
            
            <div class="space-y-2 mb-2 border-b pb-4">
                <label class="block text-sm font-bold text-gray-700">é¡¶éƒ¨å¯¼èˆªè®¾ç½®</label>
                <div class="flex gap-2">
                    <input v-model="forumName" class="w-1/2 border p-1 rounded text-sm" placeholder="è®ºå›å">
                    <input v-model="subForum" class="w-1/2 border p-1 rounded text-sm" placeholder="æ¿å—å">
                </div>
                <input v-model="threadTitle" class="w-full border p-1 rounded text-sm font-bold" placeholder="å¸–å­æ ‡é¢˜">
            </div>

            <div>
                <label class="block text-sm font-bold text-gray-700 mb-1">ğŸ­ å¿«é€Ÿé€‰æ‹©è§’è‰²</label>
                <select v-model="selectedPreset" @change="applyPreset" class="w-full border p-2 rounded text-sm bg-white">
                    <option value="" disabled>-- è¯·é€‰æ‹©é¢„è®¾è§’è‰² --</option>
                    <option v-for="role in presets" :value="role.name">
                        {{ role.name }} ({{ role.id }})
                    </option>
                </select>

                <div class="mt-2 p-2 bg-gray-50 border border-dashed rounded text-sm">
                    <div class="flex gap-2 mb-2">
                        <input v-model="newPresetName" placeholder="å¤‡æ³¨(å¦‚:åæ´¾)" class="w-1/2 border p-1 rounded text-xs">
                        <input v-model="newPresetId" placeholder="ID(å¦‚:æ€æ‰‹)" class="w-1/2 border p-1 rounded text-xs">
                    </div>
                    <button @click="addCustomPreset" class="w-full bg-gray-600 text-white py-1 rounded hover:bg-gray-700 text-xs">
                        ä¿å­˜åˆ°ä¸‹æ‹‰æ¡†
                    </button>
                </div>
            </div>

            <div>
                <label class="block text-sm font-bold">å½“å‰èº«ä»½</label>
                <div class="flex gap-2 mt-1 mb-2">
                    <button @click="currentRole = 'LZ'" :class="{'bg-blue-500 text-white': currentRole==='LZ'}" class="px-3 py-1 border rounded text-sm">æ¥¼ä¸»</button>
                    <button @click="currentRole = 'è·¯äºº'" :class="{'bg-green-500 text-white': currentRole==='è·¯äºº'}" class="px-3 py-1 border rounded text-sm">è·¯äºº</button>
                </div>
                <input v-model="currentId" class="w-full border p-2 rounded" type="text" placeholder="ç”¨æˆ·ID">
            </div>

            <div>
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-sm font-bold">å›å¤å†…å®¹</label>
                    <span v-if="insertIndex !== -1" class="text-xs font-bold text-purple-600 bg-purple-100 px-2 py-1 rounded">
                        æ­£åœ¨ï¼š{{ insertIndex }}L åæ’å…¥
                        <button @click="cancelInsert" class="ml-1 text-red-500 underline">å–æ¶ˆ</button>
                    </span>
                </div>
                <textarea v-model="content" class="w-full border p-2 rounded h-24" placeholder="è¾“å…¥å†…å®¹..."></textarea>
            </div>

            <div class="mb-2 bg-gray-50 p-2 rounded border">
                 <label class="flex items-center cursor-pointer">
                 <input type="checkbox" v-model="showAvatar" class="w-5 h-5 text-blue-600">
                 <span class="ml-2 font-bold text-gray-700 text-sm">æ˜¾ç¤ºå¤´åƒ</span>
                 </label>
            </div>
            
            <button @click="addPost" 
                :class="insertIndex !== -1 ? 'bg-purple-600 hover:bg-purple-700' : 'bg-blue-600 hover:bg-blue-700'"
                class="text-white py-2 rounded shadow transition-colors w-full mb-2">
                {{ insertIndex !== -1 ? 'âœ¨ ç¡®è®¤æ’å…¥' : 'å‘é€ (è¿½åŠ æ¥¼å±‚)' }}
            </button>
            
            <hr>
            
            <button @click="exportImage" class="bg-red-600 text-white py-2 rounded hover:bg-red-700 shadow w-full mt-2">
                ğŸ“¸ ç”Ÿæˆé•¿æˆªå›¾
            </button>
        </div>

        <div class="w-2/3 overflow-auto bg-gray-200 p-5">
            <div id="capture-area" class="preview-area min-h-[600px] w-full max-w-[600px] mx-auto shadow-lg text-sm text-gray-800 font-sans relative">
                
                <div class="bg-[#4C281B] text-white p-2 text-xs font-sans">
                     {{ forumName }} &gt; {{ subForum }} &gt; {{ threadTitle }}
                </div>

                <div v-for="(post, index) in posts" :key="index" class="post-card p-4 flex gap-3 relative group">
                    <div v-if="showAvatar" class="w-12 flex-shrink-0 text-center">
    <div class="w-10 h-10 bg-gray-200 rounded-sm mx-auto mb-1 overflow-hidden border-2 border-gray-300">
      <img v-if="post.role === 'LZ'" src="https://api.dicebear.com/7.x/pixel-art/svg?seed=lz" class="w-full h-full" />
      <img v-else :src="'https://api.dicebear.com/7.x/pixel-art/svg?seed=' + post.id" class="w-full h-full" />
    </div>
</div>
                    
                    <div class="flex-1">
                        <div class="flex justify-between text-xs text-gray-500 mb-1">
                            <span class="font-bold text-[#562214]">{{ post.id }}</span>
                            <span>{{ post.time }} | {{ index }}L</span>
                        </div>
                        <div class="leading-relaxed whitespace-pre-wrap">{{ post.content }}</div>
                    </div>

                    <div class="action-buttons absolute right-2 top-2 flex gap-1" data-html2canvas-ignore="true">
                        <button @click="prepareInsert(index)" title="åœ¨æ­¤æ¥¼åæ’å…¥" class="bg-purple-100 text-purple-600 hover:bg-purple-200 p-1 rounded text-xs">
                            â•æ’æ¥¼
                        </button>
                        <button @click="deletePost(index)" title="åˆ é™¤æ­¤æ¥¼" class="bg-red-100 text-red-600 hover:bg-red-200 p-1 rounded text-xs">
                            ğŸ—‘ï¸åˆ é™¤
                        </button>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        const { createApp, ref } = Vue;

        createApp({
            setup() {
                // --- æ•°æ®å®šä¹‰ ---
                const threadTitle = ref("æ±‚åŠ©ï¼æˆ‘çš„å®¤å‹å¥½åƒæ˜¯ä¸ªæ€æ‰‹...");
                const forumName = ref("NGAç©å®¶ç¤¾åŒº");
                const subForum = ref("æ™´é£æ‘");
                
                const currentRole = ref("LZ");
                const currentId = ref("æ— åŠ©çš„æ¥¼ä¸»");
                const content = ref("");
                const showAvatar = ref(true);
                const insertIndex = ref(-1); // -1 è¡¨ç¤ºæ­£å¸¸è¿½åŠ ï¼Œ>=0 è¡¨ç¤ºåœ¨è¯¥indexåæ’å…¥

                const posts = ref([
                    { role: 'LZ', id: 'æ— åŠ©çš„æ¥¼ä¸»', content: 'å¦‚é¢˜ï¼Œæ˜¨å¤©åŠå¤œå¬åˆ°ä»–åœ¨ç£¨åˆ€...', time: '2023-10-25 10:00' }
                ]);

                const presets = ref([
                    { name: 'æ¥¼ä¸»æœ¬äºº', role: 'LZ', id: 'æ— åŠ©çš„æ¥¼ä¸»' },
                    { name: 'è·¯äººç”²', role: 'è·¯äºº', id: 'è·¯äººç”²' },
                    { name: 'æ ç²¾', role: 'è·¯äºº', id: 'æš´èºè€å“¥' }
                ]);
                const selectedPreset = ref("");          
                const newPresetName = ref(""); 
                const newPresetId = ref("");   

                // --- æ–¹æ³•å®šä¹‰ ---

                // 1. åˆ é™¤æ¥¼å±‚
                const deletePost = (index) => {
                    if(confirm(`ç¡®å®šè¦åˆ é™¤ ${index} æ¥¼å—ï¼Ÿ`)) {
                        posts.value.splice(index, 1);
                    }
                };

                // 2. å‡†å¤‡æ’å…¥ (ç‚¹å‡»å³ä¾§åŠ å·è§¦å‘)
                const prepareInsert = (index) => {
                    insertIndex.value = index;
                    // è´´å¿ƒæç¤ºï¼šè‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†
                    document.querySelector('textarea').focus();
                };

                // 3. å–æ¶ˆæ’å…¥
                const cancelInsert = () => {
                    insertIndex.value = -1;
                };
                
                // 4. å‘é€/æ’å…¥æ ¸å¿ƒé€»è¾‘
                const addPost = () => {
                    if (!content.value) return;

                    const newPost = {
                        role: currentRole.value,
                        id: currentRole.value === 'LZ' ? 'æ— åŠ©çš„æ¥¼ä¸»' : (currentId.value || 'è·¯äººç”²'),
                        content: content.value,
                        time: new Date().toLocaleTimeString()
                    };

                    if (insertIndex.value === -1) {
                        // æ­£å¸¸è¿½åŠ åˆ°æœ€å
                        posts.value.push(newPost);
                    } else {
                        // åœ¨æŒ‡å®šä½ç½®åé¢æ’å…¥
                        posts.value.splice(insertIndex.value + 1, 0, newPost);
                        insertIndex.value = -1; // æ’å…¥å®Œå¤ä½
                    }
                    
                    content.value = "";
                    if (currentRole.value === 'è·¯äºº') {
                        // ç®€å•çš„éšæœºIDé˜²é‡å¤
                    }
                };

                const applyPreset = () => {
                    const target = presets.value.find(p => p.name === selectedPreset.value);
                    if (target) {
                        currentRole.value = target.role;
                        currentId.value = target.id;    
                    }
                };

                const addCustomPreset = () => {
                    if (!newPresetName.value || !newPresetId.value) {
                        alert("è¯·å¡«å†™è§’è‰²å¤‡æ³¨å’ŒIDï¼");
                        return;
                    }
                    presets.value.push({
                        name: newPresetName.value,
                        role: 'è·¯äºº',
                        id: newPresetId.value
                    });
                    selectedPreset.value = newPresetName.value;
                    applyPreset(); 
                    newPresetName.value = "";
                    newPresetId.value = "";
                };

                const exportImage = () => {
                    html2canvas(document.getElementById("capture-area"), {
                        // ç¡®ä¿å¿½ç•¥å¸¦æœ‰ data-html2canvas-ignore çš„å…ƒç´ 
                        ignoreElements: (element) => {
                            return element.getAttribute('data-html2canvas-ignore') === 'true';
                        }
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'forum_screenshot.png';
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                };

                return {
                    threadTitle, forumName, subForum, 
                    currentRole, currentId, content, posts, showAvatar,
                    presets, selectedPreset, newPresetName, newPresetId, insertIndex,
                    addPost, exportImage, applyPreset, addCustomPreset, 
                    deletePost, prepareInsert, cancelInsert // æ–°å¢æ–¹æ³•
                };
            }
        }).mount('#app');
    </script>
</body>
</html>